<!-- File: hackerhouse_detail.html -->
<!-- Author: Bill Jiao (jiaobill@bu.edu), 12/8/2024 -->
<!-- Description: Template for displaying a single hacker house with image gallery, -->
<!--              details, members, join/leave/follow actions, and event creation. -->

{% extends 'base.html' %}

{% block title %}{{ hackerhouse.title }}{% endblock %}

{% block content %}
<div class="detail-container">
    <!-- Header with title and status -->
    <header class="detail-header">
        <div class="status-indicator {% if hackerhouse.is_active %}active{% else %}inactive{% endif %}">
            <span class="status-dot"></span>
            <span class="status-text">{% if hackerhouse.is_active %}Active{% else %}Inactive{% endif %}</span>
        </div>
        <h1 class="detail-title">{{ hackerhouse.title }}</h1>
        <p class="detail-address">{{ hackerhouse.address }}</p>
    </header>

    <!-- Image Gallery -->
    {% if hackerhouse.images.all %}
    <div class="gallery-container">
        <button type="button" class="gallery-nav gallery-prev" aria-label="Previous image">
            <span>‹</span>
        </button>
        
        <div class="gallery-viewport">
            {% for image in hackerhouse.images.all %}
            <img src="{{ image.image.url }}" 
                 alt="{{ image.caption }}" 
                 class="gallery-image {% if forloop.first %}active{% endif %}"
                 data-index="{{ forloop.counter0 }}">
            {% endfor %}
        </div>
        
        <button type="button" class="gallery-nav gallery-next" aria-label="Next image">
            <span>›</span>
        </button>
        
        {% if hackerhouse.images.count > 1 %}
        <div class="gallery-indicators">
            {% for image in hackerhouse.images.all %}
            <button type="button" 
                    class="gallery-dot {% if forloop.first %}active{% endif %}" 
                    data-index="{{ forloop.counter0 }}"
                    aria-label="Go to image {{ forloop.counter }}"></button>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    
    <script>
    (function() {
        const container = document.querySelector('.gallery-container');
        if (!container) return;
        
        const images = container.querySelectorAll('.gallery-image');
        const dots = container.querySelectorAll('.gallery-dot');
        const prevBtn = container.querySelector('.gallery-prev');
        const nextBtn = container.querySelector('.gallery-next');
        
        if (images.length <= 1) {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
            return;
        }
        
        let currentIndex = 0;
        
        function showImage(index) {
            // Handle wrap-around
            if (index < 0) index = images.length - 1;
            if (index >= images.length) index = 0;
            
            // Update images
            images.forEach((img, i) => {
                img.classList.toggle('active', i === index);
            });
            
            // Update dots
            dots.forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
            
            currentIndex = index;
        }
        
        prevBtn.addEventListener('click', () => showImage(currentIndex - 1));
        nextBtn.addEventListener('click', () => showImage(currentIndex + 1));
        
        dots.forEach(dot => {
            dot.addEventListener('click', () => {
                showImage(parseInt(dot.dataset.index));
            });
        });
        
        // Keyboard navigation
        container.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') showImage(currentIndex - 1);
            if (e.key === 'ArrowRight') showImage(currentIndex + 1);
        });
    })();
    </script>
    {% endif %}

    <!-- Description Section -->
    <section class="description-section">
        <p class="description-text">{{ hackerhouse.description }}</p>
    </section>

    <!-- Capacity Badge -->
    <div class="capacity-section">
        <div class="capacity-display">
            <span class="capacity-number">{{ hackerhouse.members.count }}</span>
            <span class="capacity-divider">/</span>
            <span class="capacity-total">{{ hackerhouse.capacity }}</span>
        </div>
        <span class="capacity-label">Members</span>
    </div>

    <!-- Join/Leave House Action -->
    {% if user.is_authenticated %}
    <div class="house-action-section">
        {% if is_host %}
            <div class="house-action-status">
                <span class="action-icon">★</span>
                <span>You are the host</span>
            </div>
            <a href="{% url 'edit_house' hackerhouse.pk %}" class="edit-house-btn">
                <span class="action-icon">✎</span>
                <span>Edit House</span>
            </a>
        {% elif is_member %}
            <form action="{% url 'leave_house' hackerhouse.pk %}" method="post" class="house-action-form">
                {% csrf_token %}
                <button type="submit" class="house-action-btn leave-btn">
                    <span class="action-icon">←</span>
                    <span>Leave House</span>
                </button>
            </form>
        {% elif hackerhouse.members.count >= hackerhouse.capacity %}
            <div class="house-action-status full">
                <span class="action-icon">⊘</span>
                <span>House is at full capacity</span>
            </div>
        {% elif not hackerhouse.is_active %}
            <div class="house-action-status inactive">
                <span class="action-icon">⊘</span>
                <span>Not accepting new members</span>
            </div>
        {% else %}
            <form action="{% url 'join_house' hackerhouse.pk %}" method="post" class="house-action-form">
                {% csrf_token %}
                <button type="submit" class="house-action-btn join-btn">
                    <span class="action-icon">+</span>
                    <span>Join House</span>
                </button>
            </form>
        {% endif %}
        
        <!-- Follow House Button -->
        <form action="{% url 'toggle_follow_house' hackerhouse.pk %}" method="post" class="house-action-form">
            {% csrf_token %}
            <button type="submit" class="house-follow-btn {% if is_following %}following{% endif %}" title="{% if is_following %}Unfollow{% else %}Follow{% endif %}">
                <span class="follow-icon">{% if is_following %}✓{% else %}♡{% endif %}</span>
                <span class="follow-count">{{ followers_count }}</span>
            </button>
        </form>
    </div>
    {% else %}
    <div class="house-action-section">
        <a href="{% url 'login' %}?next={{ request.path }}" class="house-action-btn login-prompt-btn">
            <span class="action-icon">→</span>
            <span>Login to Join</span>
        </a>
        <span class="house-followers-count">♡ {{ followers_count }}</span>
    </div>
    {% endif %}

    <!-- Messages -->
    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="message message-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Members Section -->
    <section class="members-section">
        <h2 class="members-heading">Residents</h2>
        <div class="members-grid">
            <!-- Host (largest circle) -->
            <a href="{% url 'user_profile_detail' hackerhouse.host.pk %}?from_house={{ hackerhouse.pk }}" class="member-card host-card">
                <div class="member-avatar host-avatar">
                    {% if hackerhouse.host.profile.avatar %}
                    <img src="{{ hackerhouse.host.profile.avatar.url }}" alt="{{ hackerhouse.host.username }}">
                    {% else %}
                    <span class="avatar-initial">{{ hackerhouse.host.username|slice:":1"|upper }}</span>
                    {% endif %}
                    <span class="host-crown">★</span>
                </div>
                <span class="member-name">{{ hackerhouse.host.username }}</span>
                <span class="member-role">Host</span>
            </a>
            <!-- Other Members -->
            {% for member in hackerhouse.members.all %}
            {% if member != hackerhouse.host %}

            <a href="{% url 'user_profile_detail' member.pk %}?from_house={{ hackerhouse.pk }}" class="member-card">
                <div class="member-avatar">
                    {% if member.profile.avatar %}
                    <img src="{{ member.profile.avatar.url }}" alt="{{ member.username }}">
                    {% else %}
                    <span class="avatar-initial">{{ member.username|slice:":1"|upper }}</span>
                    {% endif %}
                </div>
                <span class="member-name">{{ member.username }}</span>
                <span class="member-role">Member</span>
            </a>
            {% endif %}
            {% empty %}
            {% endfor %}
        </div>
    </section>

    <!-- Create Event Button (Members Only) -->
    {% if user.is_authenticated and is_member or is_host %}
    <section class="create-event-cta">
        <a href="{% url 'create_house_event' hackerhouse.pk %}" class="create-event-link-btn">
            <span class="btn-icon">+</span>
            <span>Host an Event</span>
        </a>
    </section>
    {% endif %}

    <!-- Footer Info -->
    <footer class="detail-footer">
        <span class="footer-date">Listed {{ hackerhouse.created_at|date:"M d, Y" }}</span>
        <a href="{% url 'hackerhouse_list' %}" class="back-link">← Back to all houses</a>
    </footer>
</div>
{% endblock %}
